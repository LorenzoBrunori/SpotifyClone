'use strict';var _createClass=function(){function a(c,d){for(var f,e=0;e<d.length;e++)f=d[e],f.enumerable=f.enumerable||!1,f.configurable=!0,'value'in f&&(f.writable=!0),Object.defineProperty(c,f.key,f)}return function(c,d,e){return d&&a(c.prototype,d),e&&a(c,e),c}}();function _classCallCheck(a,c){if(!(a instanceof c))throw new TypeError('Cannot call a class as a function')}var _Terminal=require('./Terminal'),_ETA=require('./ETA'),_stringWidth=require('./string-width');module.exports=function(){function a(c,d){function e(g,h){return'undefined'==typeof g||null===g?h:g}_classCallCheck(this,a);var f=Object.assign({},d,c);this.timer=null,this.value=0,this.total=100,this.throttleTime=1e3/(f.fps||10),this.stream=e(f.stream,process.stderr),this.terminal=new _Terminal(this.stream),this.clearOnComplete=e(f.clearOnComplete,!1),this.stopOnComplete=e(f.stopOnComplete,!1),this.lastDrawnString=null,this.barsize=f.barsize||40,this.align=e(f.align,'left'),this.hideCursor=e(f.hideCursor,!1),this.linewrap=e(f.linewrap,!1),this.barCompleteString=Array(this.barsize+1).join(f.barCompleteChar||'='),this.barIncompleteString=Array(this.barsize+1).join(f.barIncompleteChar||'-'),this.format=f.format||'progress [{bar}] {percentage}% | ETA: {eta}s | {value}/{total}',this.startTime=null,this.lastRedraw=Date.now(),this.etaBufferLength=e(f.etaBuffer,10),this.eta=new _ETA(this.etaBufferLength,0,0),this.payload={}}return _createClass(a,[{key:'render',value:function render(){this.stopTimer();var c=this.format,d=this.value/this.total;isNaN(d)&&(d=1),d=Math.min(Math.max(d,0),1);var e=this.barCompleteString.substr(0,Math.round(d*this.barsize))+this.barIncompleteString.substr(0,Math.round((1-d)*this.barsize));e=e.substr(0,this.barsize);var f=Math.round(100*d)+'',g=Math.round((Date.now()-this.startTime)/1e3),h=a.formatTime(g,1),j=this.eta.getTime(),k=a.formatTime(j,5);for(var l in c=c.replace(/\{bar}/gi,e).replace(/\{percentage}/gi,f).replace(/\{total}/gi,this.total+'').replace(/\{value}/gi,this.value+'').replace(/\{eta}/gi,j+'').replace(/\{eta_formatted}/gi,k+'').replace(/\{duration}/gi,g+'').replace(/\{duration_formatted}/gi,h+''),this.payload){var m=RegExp('{'+l+'}','gi');c=c.replace(m,this.payload[l])}var n=Math.max(0,this.terminal.getWidth()-_stringWidth(c)-2),o=Math.floor(n/2);switch(this.align){case'right':c=0<n?' '.repeat(n)+c:c;break;case'center':c=0<o?' '.repeat(o)+c:c;break;case'left':default:}this.lastDrawnString!=c&&(this.terminal.cursorTo(0,null),this.terminal.write(c),this.terminal.clearRight(),this.lastDrawnString=c,this.lastRedraw=Date.now()),this.timer=setTimeout(this.render.bind(this),2*this.throttleTime)}},{key:'start',value:function start(c,d,e){this.value=d||0,this.total='undefined'!=typeof c&&0<=c?c:100,this.payload=e||{},this.startTime=Date.now(),this.lastDrawnString='',this.terminal.isTTY()&&(this.terminal.cursorSave(),!0===this.hideCursor&&this.terminal.cursor(!1),!1===this.linewrap&&this.terminal.lineWrapping(!1),this.stopTimer(),this.eta=new _ETA(this.etaBufferLength,this.startTime,this.value),this.render())}},{key:'stop',value:function stop(){this.timer&&(this.render(),this.stopTimer(),!0===this.hideCursor&&this.terminal.cursor(!0),!1===this.linewrap&&this.terminal.lineWrapping(!0),this.terminal.cursorRestore(),this.clearOnComplete?(this.terminal.cursorTo(0,null),this.terminal.clearLine()):this.terminal.write('\n'))}},{key:'update',value:function update(c,d){if(this.value=c,!!this.timer){this.eta.push(Date.now(),c);var e=d||{};for(var f in e)this.payload[f]=e[f];this.lastRedraw+this.throttleTime<Date.now()&&(this.eta.calculate(this.total-this.value),this.render()),this.value>=this.getTotal()&&this.stopOnComplete&&this.stop()}}},{key:'increment',value:function increment(c,d){c=c||1,this.update(this.value+c,d)}},{key:'getTotal',value:function getTotal(){return this.total}},{key:'setTotal',value:function setTotal(c){'undefined'!=typeof c&&0<=c&&(this.total=c)}},{key:'stopTimer',value:function stopTimer(){this.timer&&clearTimeout(this.timer),this.timer=null}}],[{key:'formatTime',value:function formatTime(c,d){function e(f){return d?d*Math.round(f/d):f}return 3600<c?Math.floor(c/3600)+'h'+e(c%3600/60)+'m':60<c?Math.floor(c/60)+'m'+e(c%60)+'s':10<c?e(c)+'s':c+'s'}}]),a}();